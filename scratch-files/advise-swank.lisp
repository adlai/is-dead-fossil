
(in-package :breeze.user)

;; See https://bitbucket.org/budden/budden-tools/src/default/cl-advice/cl-advice.lisp

(sb-int:encapsulated-p 'swank:eval-for-emacs 'default)

(defun dump-form (form)
  (breeze.utils:walk form (lambda (element) (cond
					      ((symbolp element) (format t " ~A:~A"
									 (package-name
									  (symbol-package element))
									 (symbol-name element)))
				 (t (format t " ~a" element))))))

(defun handle-defun (form buffer-package id)
  (format t "~&HANDLE-DEFUN"))

(defun handle-progn (form buffer-package id)
  (format t "~&HANDLE-progn"))

(defun handle-event (event buffer-package id)
  (alexandria:destructuring-case event
    ((swank:interactive-eval form)
     (format t "~&EVAL ~s~&" form)
     (if (listp form)
       (case (first form)
	 (defun (handle-defun form buffer-package id))
	 (progn (handle-progn form buffer-package id))
	 (t (format t "~&UNKNOWN ~A" (first form))))
       (format t "~&Not a list (~a) ~s~&" (type-of form) form)))))



(defun 2x (x) (* x 2))

(+ 3 3)

(handle-event '(hey) :packige 0)
(handle-event '(swank:interactive-eval 42) :packige 0)
(handle-event '(swank:interactive-eval (defun 2x (* 2 x))) :breeze.user 0)

'swank-compile-string-for-emacs

(defun my-eval-for-emacs (original-fn form buffer-package id)
  (ignore-errors
    (handler-bind
	((error #'(lambda (condition)
		    (format *error-output* "~&ERROR: ~A~&" condition))))
  
      ;; (alexandria:destructuring-case form)
      (format t "~&~%my-eval-for-emacs:~% * form: ~s~% * buffer-package: ~a~% * id: ~a~%" form buffer-package id))
      (handle-event form buffer-package id)
    ;; (dump-form form)
    )
  (funcall original-fn form buffer-package id))


(sb-int:encapsulate 'swank:eval-for-emacs :default 'my-eval-for-emacs)
(sb-int:unencapsulate 'swank:eval-for-emacs :default)

(apropos "encapsulate" 'sb-int t)

(swank::dispatch-event (swank::default-connection) '(:write-string "hi"))


(apropos "" 'swank t)

SWANK:*AFTER-TOGGLE-TRACE-HOOK* (bound)
SWANK:*BACKTRACE-PRINTER-BINDINGS* (bound)
SWANK:*COMMUNICATION-STYLE* (bound)
SWANK:*CONFIGURE-EMACS-INDENTATION* (bound)
SWANK:*DEDICATED-OUTPUT-STREAM-PORT* (bound)
SWANK:*DEFAULT-WORKER-THREAD-BINDINGS* (bound)
SWANK:*DONT-CLOSE* (bound)
SWANK:*FASL-PATHNAME-FUNCTION* (bound)
SWANK:*FIND-DEFINITIONS-LEFT-TRIM* (bound)
SWANK:*FIND-DEFINITIONS-RIGHT-TRIM* (bound)
SWANK:*FUZZY-DUPLICATE-SYMBOL-FILTER* (bound)
SWANK:*GLOBAL-DEBUGGER* (bound)
SWANK:*GLOBALLY-REDIRECT-IO* (bound)
SWANK:*INSPECTOR-VERBOSE* (bound)
SWANK:*LOG-EVENTS* (bound)
SWANK:*MACROEXPAND-PRINTER-BINDINGS* (bound)
SWANK:*READTABLE-ALIST* (bound)
SWANK:*RECORD-REPL-RESULTS* (bound)
SWANK:*SLDB-QUIT-RESTART* (bound)
SWANK:*SWANK-DEBUGGER-CONDITION* (bound)
SWANK:*SWANK-PPRINT-BINDINGS* (bound)
SWANK:*USE-DEDICATED-OUTPUT-STREAM* (bound)
SWANK:APROPOS-LIST-FOR-EMACS (fbound)
SWANK:ARGLIST-DISPATCH (fbound)
SWANK:AUTODOC (fbound)
SWANK:BACKTRACE (fbound)
SWANK:CLEAR-REPL-RESULTS (fbound)
SWANK:COMMIT-EDITED-VALUE (fbound)
SWANK:COMPILE-FILE-FOR-EMACS (fbound)
SWANK:COMPILE-FILE-IF-NEEDED (fbound)
SWANK:COMPILE-MULTIPLE-STRINGS-FOR-EMACS (fbound)
SWANK:COMPILE-STRING-FOR-EMACS (fbound)
SWANK:COMPLETE-FORM (fbound)
SWANK:COMPLETIONS (fbound)
SWANK:COMPLETIONS-FOR-CHARACTER (fbound)
SWANK:COMPLETIONS-FOR-KEYWORD (fbound)
SWANK:CONNECTION-INFO (fbound)
SWANK:CREATE-SERVER (fbound)
SWANK:DEBUG-NTH-THREAD (fbound)
SWANK:DEBUG-ON-SWANK-ERROR (fbound)
SWANK:DEBUGGER-INFO-FOR-EMACS (fbound)
SWANK:DESCRIBE-DEFINITION-FOR-EMACS (fbound)
SWANK:DESCRIBE-FUNCTION (fbound)
SWANK:DESCRIBE-INSPECTEE (fbound)
SWANK:DESCRIBE-SYMBOL (fbound)
SWANK:DISASSEMBLE-FORM (fbound)
SWANK:DOCUMENTATION-SYMBOL (fbound)
SWANK:ED-IN-EMACS (fbound)
SWANK:ED-RPC (fbound)
SWANK:ED-RPC-NO-WAIT (fbound)
SWANK:EVAL-AND-GRAB-OUTPUT (fbound)
SWANK:EVAL-FOR-EMACS (fbound)
SWANK:EVAL-IN-EMACS (fbound)
SWANK:EVAL-STRING-IN-FRAME (fbound)
SWANK:EXPORT-STRUCTURE (fbound)
SWANK:EXPORT-SYMBOL-FOR-EMACS (fbound)
SWANK:FIND-DEFINITION-FOR-THING (fbound)
SWANK:FIND-DEFINITIONS-FOR-EMACS (fbound)
SWANK:FIND-SOURCE-LOCATION-FOR-EMACS (fbound)
SWANK:FLOW-CONTROL-TEST (fbound)
SWANK:FRAME-LOCALS-AND-CATCH-TAGS (fbound)
SWANK:FRAME-PACKAGE-NAME (fbound)
SWANK:FROM-STRING (fbound)
SWANK:FUZZY-COMPLETION-SELECTED (fbound)
SWANK:FUZZY-COMPLETIONS (fbound)
SWANK:INIT-INSPECTOR (fbound)
SWANK:INIT-PRESENTATIONS (fbound)
SWANK:INSPECT-CURRENT-CONDITION (fbound)
SWANK:INSPECT-FRAME-VAR (fbound)
SWANK:INSPECT-IN-EMACS (fbound)
SWANK:INSPECT-IN-FRAME (fbound)
SWANK:INSPECT-NTH-PART (fbound)
SWANK:INSPECT-PRESENTATION (fbound)
SWANK:INSPECTOR-CALL-NTH-ACTION (fbound)
SWANK:INSPECTOR-EVAL (fbound)
SWANK:INSPECTOR-HISTORY (fbound)
SWANK:INSPECTOR-NEXT (fbound)
SWANK:INSPECTOR-NTH-PART (fbound)
SWANK:INSPECTOR-POP (fbound)
SWANK:INSPECTOR-RANGE (fbound)
SWANK:INSPECTOR-REINSPECT (fbound)
SWANK:INSPECTOR-TOGGLE-VERBOSE (fbound)
SWANK:INTERACTIVE-EVAL (fbound)
SWANK:INTERACTIVE-EVAL-REGION (fbound)
SWANK:INVOKE-NTH-RESTART (fbound)
SWANK:INVOKE-NTH-RESTART-FOR-EMACS (fbound)
SWANK:INVOKE-SLIME-DEBUGGER (fbound)
SWANK:IO-SPEED-TEST (fbound)
SWANK:KILL-NTH-THREAD (fbound)
SWANK:LIST-ALL-PACKAGE-NAMES (fbound)
SWANK:LIST-THREADS (fbound)
SWANK:LOAD-FILE (fbound)
SWANK:LOOKUP-AND-SAVE-PRESENTED-OBJECT-OR-LOSE (fbound)
SWANK:LOOKUP-PRESENTED-OBJECT (fbound)
SWANK:LOOKUP-PRESENTED-OBJECT-OR-LOSE (fbound)
SWANK:MAKE-OUTPUT-FUNCTION-FOR-TARGET (fbound)
SWANK:MAKE-OUTPUT-STREAM-FOR-TARGET (fbound)
SWANK:MOP (fbound)
SWANK:OPERATOR-ARGLIST (fbound)
SWANK:PACKAGE= (fbound)
SWANK:PARSE-STRING (fbound)
SWANK:PING (fbound)
SWANK:PPRINT-EVAL (fbound)
SWANK:PPRINT-EVAL-STRING-IN-FRAME (fbound)
SWANK:PPRINT-INSPECTOR-PART (fbound)
SWANK:PRINT-INDENTATION-LOSSAGE (fbound)
SWANK:PROFILE-BY-SUBSTRING (fbound)
SWANK:QUIT-INSPECTOR (fbound)
SWANK:QUIT-THREAD-BROWSER (fbound)
SWANK:RE-EVALUATE-DEFVAR (fbound)
SWANK:RESTART-SERVER (fbound)
SWANK:RUN-HOOK-WITH-ARGS-UNTIL-SUCCESS
SWANK:SDLB-PRINT-CONDITION (fbound)
SWANK:SET-PACKAGE (fbound)
SWANK:SIMPLE-BREAK (fbound)
SWANK:SIMPLE-COMPLETIONS (fbound)
SWANK:SLDB-ABORT (fbound)
SWANK:SLDB-BREAK (fbound)
SWANK:SLDB-BREAK-WITH-DEFAULT-DEBUGGER (fbound)
SWANK:SLDB-CONTINUE (fbound)
SWANK:SLDB-DISASSEMBLE (fbound)
SWANK:SLDB-NEXT (fbound)
SWANK:SLDB-OUT (fbound)
SWANK:SLDB-RETURN-FROM-FRAME (fbound)
SWANK:SLDB-STEP (fbound)
SWANK:START-SERVER (fbound)
SWANK:START-SWANK-SERVER-IN-THREAD (fbound)
SWANK:STARTUP-MULTIPROCESSING
SWANK:STOP-SERVER (fbound)
SWANK:SWANK-COMPILER-MACROEXPAND (fbound)
SWANK:SWANK-COMPILER-MACROEXPAND-1 (fbound)
SWANK:SWANK-DEBUGGER-HOOK (fbound)
SWANK:SWANK-DELETE-PACKAGE (fbound)
SWANK:SWANK-EXPAND (fbound)
SWANK:SWANK-EXPAND-1 (fbound)
SWANK:SWANK-FORMAT-STRING-EXPAND (fbound)
SWANK:SWANK-MACROEXPAND (fbound)
SWANK:SWANK-MACROEXPAND-1 (fbound)
SWANK:SWANK-MACROEXPAND-ALL (fbound)
SWANK:SWANK-PROFILE-PACKAGE (fbound)
SWANK:SWANK-REQUIRE (fbound)
SWANK:SWANK-TOGGLE-TRACE (fbound)
SWANK:THROW-TO-TOPLEVEL (fbound)
SWANK:TO-STRING (fbound)
SWANK:TOGGLE-BREAK-ON-SIGNALS (fbound)
SWANK:TOGGLE-DEBUG-ON-SWANK-ERROR (fbound)
SWANK:TOGGLE-PROFILE-FDEFINITION (fbound)
SWANK:UNDEFINE-FUNCTION (fbound)
SWANK:UNEXPORT-SYMBOL-FOR-EMACS (fbound)
SWANK:UNINTERN-SYMBOL (fbound)
SWANK:UNREADABLE-RESULT
SWANK:UNREADABLE-RESULT-P (fbound)
SWANK:UNREADABLE-RESULT-STRING (fbound)
SWANK:UNTRACE-ALL (fbound)
SWANK:UPDATE-INDENTATION-INFORMATION (fbound)
SWANK:VALUE-FOR-EDITING (fbound)
SWANK:XREF (fbound)
SWANK:XREFS (fbound)
SWANK:Y-OR-N-P-IN-EMACS (fbound)



(swank:y-or-n-p-in-emacs "Do you?")




(ppcre:regex-apropos-list "^\\*.*\\*$" :swank)

SWANK/BACKEND:*AUTO-FLUSH-INTERVAL*
SWANK/BACKEND:*DEBUG-SWANK-BACKEND*
SWANK/BACKEND:*INTERRUPT-QUEUED-HANDLER*
SWANK/BACKEND:*LOG-OUTPUT*
SWANK/BACKEND:*PENDING-SLIME-INTERRUPTS*

SWANK:*AFTER-TOGGLE-TRACE-HOOK*
SWANK:*BACKTRACE-PRINTER-BINDINGS*
SWANK:*COMMUNICATION-STYLE*
SWANK:*CONFIGURE-EMACS-INDENTATION*
SWANK:*DEDICATED-OUTPUT-STREAM-PORT*
SWANK:*DEFAULT-WORKER-THREAD-BINDINGS*
SWANK:*DONT-CLOSE*
SWANK:*FASL-PATHNAME-FUNCTION*
SWANK:*FIND-DEFINITIONS-LEFT-TRIM*
SWANK:*FIND-DEFINITIONS-RIGHT-TRIM*
SWANK:*FUZZY-DUPLICATE-SYMBOL-FILTER*
SWANK:*GLOBAL-DEBUGGER*
SWANK:*GLOBALLY-REDIRECT-IO*
SWANK:*INSPECTOR-VERBOSE*
SWANK:*LOG-EVENTS*
SWANK:*MACROEXPAND-PRINTER-BINDINGS*
SWANK:*READTABLE-ALIST*
SWANK:*RECORD-REPL-RESULTS*
SWANK:*SLDB-QUIT-RESTART*
SWANK:*SWANK-DEBUGGER-CONDITION*
SWANK:*SWANK-PPRINT-BINDINGS*
SWANK:*USE-DEDICATED-OUTPUT-STREAM*

SWANK::*AFTER-INIT-HOOK*
SWANK::*ALL-CHUNKS*
SWANK::*ARGLIST-PPRINT-BINDINGS*
SWANK::*ARGLIST-SHOW-PACKAGES*
SWANK::*AUTO-ABBREVIATE-DOTTED-PACKAGES*
SWANK::*BACKTRACE-PPRINT-DISPATCH-TABLE*
SWANK::*BUFFER-PACKAGE*
SWANK::*BUFFER-READTABLE*
SWANK::*CANONICAL-PACKAGE-NICKNAMES*
SWANK::*CHANNEL-COUNTER*
SWANK::*CHANNELS*
SWANK::*COMPILE-FILE-FOR-EMACS-HOOK*
SWANK::*CONNECTION-CLOSED-HOOK*
SWANK::*CONNECTIONS*
SWANK::*CURRENT-DEBUG-IO*
SWANK::*CURRENT-ERROR-OUTPUT*
SWANK::*CURRENT-QUERY-IO*
SWANK::*CURRENT-STANDARD-INPUT*
SWANK::*CURRENT-STANDARD-OUTPUT*
SWANK::*CURRENT-TERMINAL-IO*
SWANK::*CURRENT-TRACE-OUTPUT*
SWANK::*DEBUG-ON-SWANK-PROTOCOL-ERROR*
SWANK::*ECHO-AREA-PREFIX*
SWANK::*EMACS-CONNECTION*
SWANK::*ENABLE-EVENT-HISTORY*
SWANK::*EVENT-HISTORY*
SWANK::*EVENT-HISTORY-INDEX*
SWANK::*EVENT-HOOK*
SWANK::*FIND-MODULE*
SWANK::*FUZZY-COMPLETION-SYMBOL-PREFIXES*
SWANK::*FUZZY-COMPLETION-SYMBOL-SUFFIXES*
SWANK::*FUZZY-COMPLETION-WORD-SEPARATORS*
SWANK::*FUZZY-RECURSION-SOFT-LIMIT*
SWANK::*GF-METHOD-GETTER*
SWANK::*INSPECTOR-HISTORY*
SWANK::*INSPECTOR-PRINTER-BINDINGS*
SWANK::*INSPECTOR-SLOTS-DEFAULT-GROUPING*
SWANK::*INSPECTOR-SLOTS-DEFAULT-ORDER*
SWANK::*INSPECTOR-VERBOSE-PRINTER-BINDINGS*
SWANK::*IO-INTERUPT-LEVEL*
SWANK::*ISTATE*
SWANK::*LOAD-PATH*
SWANK::*LOOPBACK-INTERFACE*
SWANK::*NEW-CONNECTION-HOOK*
SWANK::*NIL-SURROGATE*
SWANK::*OBJECT-TO-PRESENTATION-ID*
SWANK::*PENDING-CONTINUATIONS*
SWANK::*PRE-REPLY-HOOK*
SWANK::*PRESENTATION-ACTIVE-MENU*
SWANK::*PRESENTATION-COUNTER*
SWANK::*PRESENTATION-ID-TO-OBJECT*
SWANK::*SEND-COUNTER*
SWANK::*SERVERS*
SWANK::*SLDB-CONDITION-PRINTER*
SWANK::*SLDB-INITIAL-FRAMES*
SWANK::*SLDB-LEVEL*
SWANK::*SLDB-RESTARTS*
SWANK::*SLDB-STEPPING-P*
SWANK::*SLIME-FEATURES*
SWANK::*SLIME-INTERRUPTS-ENABLED*
SWANK::*SWANK-DEBUG-P*
SWANK::*SWANK-IO-PACKAGE*
SWANK::*SWANK-WIRE-PROTOCOL-VERSION*
SWANK::*TAG-COUNTER*
SWANK::*THREAD-LIST*
